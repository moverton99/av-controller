<!DOCTYPE html>
<html lang="en">

<head>
    <title>AV Controller</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

</head>

<body>
    <div id="device-dialog">
        <label for="deviceList">Select a device type:</label>
        <select id="deviceList"></select>
        <button onclick="startDiscovery()">Find</button>
        <div id="devices"></div>

        <h2>Saved Devices</h2>
        <div id="deviceListContainer"></div>

        <hr>
        <h3>Log</h3>
        <div id="log"></div>

        <script>
            let deviceMeta = null;

            function appendLog(msg, isError = false) {
                const div = document.getElementById('log');
                const line = document.createElement('div');
                const timestamp = new Date().toISOString().slice(11, 19);
                line.textContent = `[${timestamp}] ${msg}`;
                if (isError) line.style.color = 'red';
                div.appendChild(line);
                div.scrollTop = div.scrollHeight;
            }

            async function loadDeviceTypes() {
                appendLog("🔍 Loading device types...");
                try {
                    const res = await fetch('/device-list');
                    const types = await res.json();
                    const select = document.getElementById('deviceList');
                    select.innerHTML = '';
                    types.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.filename;
                        opt.textContent = t.device;
                        opt.dataset.testCommand = t.test_command;
                        opt.dataset.testPrep = t.test_prep_instructions;
                        opt.dataset.testConfirm = t.test_confirmation;
                        select.appendChild(opt);
                    });
                    document.getElementById('device-dialog').style.display = 'block';
                    appendLog(`✓ Loaded ${types.length} device type(s).`);
                } catch (err) {
                    appendLog(`✗ Failed to load device types: ${err}`, true);
                }
            }

            async function startDiscovery() {
                const select = document.getElementById('deviceList');
                const filename = select.value;
                const prep = select.selectedOptions[0].dataset.testPrep;

                if (!confirm(prep)) {
                    appendLog("⚠️ Discovery cancelled by user.");
                    return;
                }

                appendLog(`🔎 Starting discovery for ${filename}...`);
                try {
                    const res = await fetch(`/find-device?config=${filename}`);
                    const data = await res.json();
                    if (data.found) {
                        appendLog(`✓ Device found at ${data.ip}. Saved to registry.`);
                        alert('Device found and saved.');
                        location.reload();
                    } else {
                        appendLog(`✗ Device not found.`);
                        alert('Device not found.');
                    }
                } catch (err) {
                    appendLog(`✗ Error during discovery: ${err}`, true);
                    alert('An error occurred during discovery.');
                }
            }

            async function loadRegistry() {
                appendLog("📦 Loading device registry...");
                try {
                    const res = await fetch('/registry');
                    const registry = await res.json();
                    const container = document.getElementById('deviceListContainer');
                    container.innerHTML = '';

                    Object.entries(registry).forEach(([id, device]) => {
                        const div = document.createElement('div');
                        div.className = 'device';

                        const title = document.createElement('h3');
                        title.textContent = `${device.name} (${id})`;
                        div.appendChild(title);

                        const commands = ['power_on', 'power_off'];
                        commands.forEach(cmd => {
                            const btn = document.createElement('button');
                            btn.textContent = cmd;
                            btn.onclick = () => sendCommand(id, device.ip, device.config, cmd);
                            div.appendChild(btn);
                        });

                        const forget = document.createElement('button');
                        forget.textContent = 'Forget';
                        forget.onclick = async () => {
                            appendLog(`🗑 Forgetting device ${id}...`);
                            await fetch(`/forget-device?id=${id}`, { method: 'POST' });
                            appendLog(`✓ Device ${id} removed.`);
                            location.reload();
                        };
                        div.appendChild(forget);

                        container.appendChild(div);
                    });

                    appendLog(`✓ Loaded ${Object.keys(registry).length} device(s).`);
                } catch (err) {
                    appendLog(`✗ Failed to load registry: ${err}`, true);
                }
            }

            async function sendCommand(id, ip, config, command) {
                const url = `/send/${command}?id=${id}&ip=${ip}&config=${config}`;
                appendLog(`→ Sending '${command}' to ${id}`);
                try {
                    const res = await fetch(url, { method: 'POST' });
                    const text = await res.text();
                    appendLog(`✓ ${command} succeeded: ${text}`);
                } catch (err) {
                    appendLog(`✗ ${command} failed: ${err}`, true);
                }
            }

            loadRegistry(); // Auto-load on page load
        </script>

</body>

</html>